# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Example Deployment and Service for `apigee-remote-service-envoy` in Hybrid.
# Default is to deploy into the `apigee` namespace. If you specified a different
# namespace for your runtime, you must change these in order to access secrets.

# Important: Replace ${ORGANIZATION} and ${ENVIRONMENT} and ${HASH} in the 
# configuration below! 
# Note: you can see the ${HASH} value used in the config generated by the CLI
# or get the full `tls-volume` secret name by querying kubernetes:
# `kubectl -n apigee get secrets | grep apigee-udca`

apiVersion: cert-manager.io/v1alpha3
kind: Certificate
metadata:
  name: apigee-remote-service-envoy
  namespace: apigee
spec:
  commonName: apigee-remote-service-envoy
  isCA: true
  dnsNames:
  - apigee-remote-service-envoy
  - apigee-remote-service-envoy.apigee
  - apigee-remote-service-envoy.apigee.svc.cluster.local
  duration: 87600h0m0s
  issuerRef:
    group: cert-manager.io
    kind: Issuer
    name: nandanks-serverless-ca-issuer
  secretName: apigee-remote-service-envoy-tls
  usages:
  - digital signature
  - key encipherment
  - client auth
  - server auth
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apigee-remote-service-envoy
  namespace: apigee
  annotations:
    sidecar.istio.io/rewriteAppHTTPProbers: "true"
    prometheus.io/path: /metrics
    prometheus.io/port: "5001"
    prometheus.io/scheme: https
    prometheus.io/scrape: "true"
    prometheus.io/type: prometheusspec
spec:
  replicas: 1
  selector:
    matchLabels:
      app: apigee-remote-service-envoy
  template:
    metadata:
      labels:
        app: apigee-remote-service-envoy
        version: v1
    spec:
      containers:
      - name: apigee-remote-service-envoy
        image: "gcr.io/nandanks-serverless/apigee-envoy-adapter:v1.0.0"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5000
        livenessProbe:
          httpGet:
            path: /healthz
            port: 5001
          failureThreshold: 1
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthz
            port: 5001
          failureThreshold: 30
          periodSeconds: 10
        args:
          - --log-level=debug
          - --config=/config/config.yaml
        resources:
          limits:
            cpu: 100m
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 100Mi
        volumeMounts:
        - mountPath: /config
          name: apigee-remote-service-envoy
          readOnly: true
        - mountPath: /opt/apigee/tls
          name: tls-volume
          readOnly: true
        - mountPath: /policy-secret
          name: policy-secret
          readOnly: true
      volumes:
      - name: apigee-remote-service-envoy
        configMap:
          name: apigee-remote-service-envoy
      - name: tls-volume
        secret:
          defaultMode: 420
          secretName: apigee-remote-service-envoy-tls
      - name: policy-secret
        secret:
          defaultMode: 420
          secretName: nandanks-serverless-prod1-policy-secret
---
apiVersion: v1
kind: Service
metadata:
  name: apigee-remote-service-envoy
  namespace: apigee
  labels:
    app: apigee-remote-service-envoy
spec:
  ports:
  - port: 5000
    name: grpc
  selector:
    app: apigee-remote-service-envoy
---
# Configuration for apigee-remote-service-envoy (platform: GCP)
# generated by apigee-remote-service-cli provision on 2020-08-15 14:54:30
# WARNING: verification of provision failed. May not be valid.
apiVersion: v1
kind: ConfigMap
metadata:
  name: apigee-remote-service-envoy
  namespace: apigee
data:
  config.yaml: |
    tenant:
      remote_service_api: https://api.nandanks-serverless.internal/remote-service
      org_name: nandanks-serverless
      env_name: prod1
      allow_unverified_ssl_cert: true
    analytics:
      collection_interval: 10s
      fluentd_endpoint: apigee-udca-nandanks-serverless-prod1.apigee:20001
      tls:
        ca_file: /opt/apigee/tls/ca.crt
        key_file: /opt/apigee/tls/tls.key
        cert_file: /opt/apigee/tls/tls.crt
---
apiVersion: v1
kind: Secret
metadata:
  name: nandanks-serverless-prod1-policy-secret
  namespace: apigee
type: Opaque
data:
  remote-service.crt: eyJrZXlzIjpbeyJrdHkiOiJSU0EiLCJhbGciOiJSUzI1NiIsImUiOiJBUUFCIiwia2lkIjoiMjAyMC0wOC0xNVQxNDo1NDozMC0wNzowMCIsIm4iOiIwUGg1QzAtc3dQZEpXaDFVeUpCcWZiTXdfcjhPaHpZdVZTMk5IN095M3pLeFBJWGowbFNJVTRtNXpMOUZDNUxadEREVlFveEo5QnJCdXI5YXozWlRNNGUySzZTREFyeEhMRzFzRUJLVlVXX0J0MGw4WlNDOFY5YjdlTEZTUDVMSnJYQ2RWVFUzN3ZIUDVvaHFJb1R3Z040c2R2czI0WXdNSnlMSTNCZEl5dEtBWndCSDctMTdTQ05XZllHU01CM3phNktfdnRNS2tabnlzdTE1eWxZdzNjRGVLVk5IYUFTU1REUFUzeHpNUFQzLUlHbzhkdGpJMm5lcG5EczRseGRtU1llcloxSEVoMmF0bmZiNkhVb2VWaVdWenh5d2JFUlV0a2ZrRDRCWWJLdXdOT01Lblg5OUpCd0V0WGtEWG93dHQ3aWk5dWdGZmdtYUhYVlBkakxrQncifV19
  remote-service.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBMFBoNUMwK3N3UGRKV2gxVXlKQnFmYk13L3I4T2h6WXVWUzJOSDdPeTN6S3hQSVhqCjBsU0lVNG01ekw5RkM1TFp0RERWUW94SjlCckJ1cjlhejNaVE00ZTJLNlNEQXJ4SExHMXNFQktWVVcvQnQwbDgKWlNDOFY5YjdlTEZTUDVMSnJYQ2RWVFUzN3ZIUDVvaHFJb1R3Z040c2R2czI0WXdNSnlMSTNCZEl5dEtBWndCSAo3KzE3U0NOV2ZZR1NNQjN6YTZLL3Z0TUtrWm55c3UxNXlsWXczY0RlS1ZOSGFBU1NURFBVM3h6TVBUMytJR284CmR0akkybmVwbkRzNGx4ZG1TWWVyWjFIRWgyYXRuZmI2SFVvZVZpV1Z6eHl3YkVSVXRrZmtENEJZYkt1d05PTUsKblg5OUpCd0V0WGtEWG93dHQ3aWk5dWdGZmdtYUhYVlBkakxrQndJREFRQUJBb0lCQUZQRzZiQXhOdzc5bExpOQovWm1TM0Q2Y3NrM1BCdUlLUkxUOVdCQ1htR1NIRENzNWVrWitnVkVNYkNLN285Q3FCUUdLZWxUOXJVQmg0YjBlCnJpZHlScFRvR1k2Um03eGpBeDI2bUpJeEFRL3UvL2lkUzNPM2xncVpNNlFGWXZYOXdVRDVYdm9rSmRKenUyZXUKMU80VjRkMm9OS2RXdTMvZEI1cEJCY25Hdy9ZYmlBV0U2KzRtL2dWSHRCTTJOMHRxNXQ4aEFLSGhxeWVQYXV1agp1SVROWG9HOXlMNGxzUWp5U25JRnZ3WVZQMHFDdytHZ0tieVI1Qm5oZEtuVjY1c3lRa2RZZWFuZ2RoWFZCQit4CjdzUmlQaFJ6N0lFZGxQR2Q5TVF5ZG1rS21SNEowam9BU1dVbGlMNDRkUE4wU2N2eDFJa0VUMFZsbTBrZTF3bnkKUmk4VGZoRUNnWUVBL1kvNWk0ajVuQkE2Z1UvYzZ5WERlVXZRTGQyQnhwZzNCdHVpZXNYdjVGR1QvTlFRZjZJRgpTdzRGUmRiNWJ3eDNubFNqWTVJclRTR01VNjFEWG5FOWsvYTRXd0lOb1dtN3ZBQ3N2bTZnTVVjckpZdkgyTVBUClBWMUhGa1hzbEw5cXZXUkk4aVdiL0FuODlxWkhlbHFBcWFodXpGK1l5Nll0Zlc2SDZ6dXpsUXNDZ1lFQTB2ckIKbFFjdlRqR2pMRldncHhvN3Zrb1NTMk1pOUZhcU15Y2s2c2plT25qclhFSGkrSlQrZkRtUHhOWS91VC9NZlVHbgpJUExvSWVqRG1MUGd5UGdPejh0RlVURHNTbGNhd3FUWnNRZVNwM0hCNzhHSExUYW1FbzFwT24yTWZvTHJQZ2xECjFTOTNWVlkxRlU4eUw0S08wSEMzQlZMWDRabG5KbHhVTHhNUEVuVUNnWUFoa3p6eDh4TktUUVBTTjZjREpCNzgKSXNQUUx2S09QMzJaMU45dzdtRFRsTkhKdXJMc2s2R3J6SkY2Sy9zZmIwRXZuL2w2cDlKQUJsODBmVTdjWkpaSQp6M1NkNkdteG8vU044bkR0VG15NzJiYW01QmwwWkluR0tHSFBXemIyZzFvNDlkeUs0OXdCeGJqUFdEbEN4RlVoCklnSjU0WGEwRUs4Wld0ZDRtSkV3L1FLQmdFVVZ2MVhoYUdnZWNPUVBsZStoODNZNEl3MTBoUG1sZDA0UXYxSHkKUEhMQkxiQ2tFb0o3cDJsZUgrbkFqbFZHd3RzeEtGenRyWDJORHA5dUoya25jUkl4Nlp6UWZFOUxmb1BHSDFLTQp2RVVBUnhVUE5naGtJTFZxZ002YVZlc0hTNmlndUFtUzVXeVlNZ0dzVVM2bGZjWmJZbExuOGJENTNvRDlNc1BIClplUVJBb0dCQVB0b3Q5d2hBbG15ZjQ4YWpvVm0yZlQ2YVEyR0tOUzhjMFJrWjczUHNnc0Jld25xaTZnaTNmLzYKMXVsYlBadVZFUzNIUld6Sk00aitnVHE1cFV3KzJLbW10SnhDRkZVUkNmcERGSnZmcUEwUlc4Z0ZSM3BqUXcwKwppcFB5M3M0YWQzZWN3T1FZbXJSL1lDNUszdnFVUDBRVFcxM1FBYmJUQzRQWTNPRkZlYkE0Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
  remote-service.properties: a2lkPTIwMjAtMDgtMTVUMTQ6NTQ6MzAtMDc6MDA=